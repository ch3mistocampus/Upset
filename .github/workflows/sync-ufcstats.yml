name: Sync UFC Stats Data

on:
  # Scheduled runs
  schedule:
    # Weekly Monday at 6am UTC - sync events list
    - cron: '0 6 * * 1'
    # Daily at 12pm UTC - sync next event card
    - cron: '0 12 * * *'
    # Every 3 hours - sync results and grade picks (baseline)
    - cron: '0 */3 * * *'
    # Sunday 2pm UTC (9am ET) - results catch-up after Saturday night events
    - cron: '0 14 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      function:
        description: 'Which function to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - sync-events
          - sync-next-event-card
          - sync-recent-results-and-grade

jobs:
  sync-events:
    runs-on: ubuntu-latest
    concurrency:
      group: sync-events
      cancel-in-progress: false
    if: >-
      github.event.schedule == '0 6 * * 1' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.function == 'all' || github.event.inputs.function == 'sync-events'))

    steps:
      - name: Sync Events
        run: |
          response=$(curl -s -X POST "${{ secrets.SUPABASE_FUNCTION_URL }}/sync-events?force=true" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          # Check if request was successful
          if [[ $response == *"\"success\":true"* ]]; then
            echo "Events synced successfully"
          else
            echo "Failed to sync events"
            echo "$response"
            exit 1
          fi

  sync-next-event-card:
    runs-on: ubuntu-latest
    concurrency:
      group: sync-next-event-card
      cancel-in-progress: false
    if: >-
      github.event.schedule == '0 12 * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.function == 'all' || github.event.inputs.function == 'sync-next-event-card'))

    steps:
      - name: Sync Next Event Card
        run: |
          response=$(curl -s -X POST "${{ secrets.SUPABASE_FUNCTION_URL }}/sync-next-event-card" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          if [[ $response == *"\"success\":true"* ]]; then
            echo "Next event card synced successfully"
          else
            echo "Failed to sync next event card"
            echo "$response"
            exit 1
          fi

  sync-results-and-grade:
    runs-on: ubuntu-latest
    concurrency:
      group: sync-results-and-grade
      cancel-in-progress: false
    if: >-
      github.event.schedule == '0 */3 * * *' ||
      github.event.schedule == '0 14 * * 0' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.function == 'all' || github.event.inputs.function == 'sync-recent-results-and-grade'))

    steps:
      - name: Sync Results and Grade Picks
        run: |
          response=$(curl -s -X POST "${{ secrets.SUPABASE_FUNCTION_URL }}/sync-recent-results-and-grade?force=true" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          if [[ $response == *"\"success\":true"* ]]; then
            echo "Results synced and picks graded successfully"
          else
            echo "Failed to sync results"
            echo "$response"
            exit 1
          fi
